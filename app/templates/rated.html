{% extends "base.html" %}

{% block title %}Rated Tracks - Vocaloid Rater{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  {% include "partials/header.html" %}

  <div class="grid-cols mb-4 grid grid-cols-1 gap-6 md:grid-cols-4">
    <div class="rounded border border-border bg-card-bg p-6 shadow-md">
      <h2
        class="mt-0 border-b border-border pb-1 text-2xl font-semibold text-header"
      >
        Top Producers
      </h2>
      {% if stats.top_producers %}
        <ul>
          {% for producer in stats.top_producers %}
            <li
              class="flex justify-between border-b border-border px-0 py-2 last:border-b-0"
            >
              <a
                href="#"
                class="filter-link font-bold hover:text-sky-text hover:underline"
                data-filter-type="producer_filter"
                data-filter-value="{{ producer.name }}"
              >
                <span>{{ producer.name }}</span>
              </a>
              <span class="text-header">{{ producer.avg_rating }} ★ avg</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="detail">
          Not enough data. Rate at least 3 tracks from the same producer.
        </p>
      {% endif %}
    </div>

    <div class="rounded border border-border bg-card-bg p-6 shadow-md">
      <h2
        class="mt-0 border-b border-border pb-1 text-2xl font-semibold text-header"
      >
        Top Voicebanks
      </h2>
      {% if stats.top_voicebanks %}
        <ul class="top-list">
          {% for voicebank in stats.top_voicebanks %}
            <li
              class="flex justify-between border-b border-border px-0 py-2 last:border-b-0"
            >
              <a
                href="#"
                class="filter-link font-bold hover:text-sky-text hover:underline"
                data-filter-type="voicebank_filter"
                data-filter-value="{{ voicebank.name }}"
              >
                <span>{{ voicebank.name }}</span>
              </a>
              <span class="text-header">{{ voicebank.avg_rating }} ★ avg</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="detail">
          Not enough data. Rate at least 3 tracks from the same voicebank.
        </p>
      {% endif %}
    </div>

    <div class="rounded border border-border bg-card-bg p-6 shadow-md">
      <h2
        class="mt-0 border-b border-border pb-1 text-2xl font-semibold text-header"
      >
        Overall Stats (Across {{ stats.total_ratings }} ratings)
      </h2>
      <div class="mx-0 my-2 flex items-center justify-around text-center">
        <div>
          <div class="text-3xl font-semibold">{{ stats.average_rating }} ★</div>
          <div>Average</div>
        </div>
        <div>
          <div class="text-3xl font-semibold">{{ stats.median_rating }} ★</div>
          <div>Median</div>
        </div>
      </div>
    </div>

    {% if stats.total_ratings > 0 %}
      <div class="rounded border border-border bg-card-bg p-6 shadow-md">
        <h2
          class="mt-0 border-b border-border pb-1 text-2xl font-semibold text-header"
        >
          Rating Distribution
        </h2>
        <canvas
          id="ratingDistributionChart"
          data-ratings="{{ stats.rating_distribution | tojson | forceescape }}"
        ></canvas>
      </div>
    {% endif %}
  </div>

  {%
    set context = {
        "filters": filters,
        "all_producers": all_producers,
        "all_voicebanks": all_voicebanks,
        "pagination": pagination,
        "show_status_filter": false,
        "show_rating_filter": false,
        "show_pagination_limit_filter": true,
        "show_scrape_button": false
    }
  %}
  {% include "partials/filter_form.html" %}

  <div
    class="overflow-x-visible rounded border border-none border-border bg-card-bg shadow-md md:overflow-x-auto"
  >
    <table class="w-full border-collapse">
      {% include "partials/tracks_table_head.html" %}
      <tbody
        id="tracks-table-body"
        class="tracks-table-body"
        data-update-url="/_/rated_tracks_table_body"
      >
        {% include "partials/tracks_table_body.html" %}
      </tbody>
    </table>
  </div>

  <script src="{{ url_for('static', path='js/main.min.js') }}"></script>
{% endblock %}

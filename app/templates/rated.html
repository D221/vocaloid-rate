{% extends "base.html" %}

{% block title %}Rated Tracks - Vocaloid Rater{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="header-container">
    <h1>Rated Tracks</h1>
    <div class="header-controls">
        <a href="/" class="header-button">Back to Main Chart</a>
        <a href="/options" class="header-button">Options</a>
        <div class="theme-switcher" id="theme-switcher">
            <span id="theme-icon"><i class="fa-solid fa-moon"></i></span>
        </div>
    </div>
</div>

<div class="stats-container">
    <!-- Card 1: Combined Average and Median -->
    <div class="stat-card">
        <h3>Overall Stats</h3>
        <div class="value-group">
            <div>
                <div class="sub-value">{{ stats.average_rating }} ★</div>
                <div class="sub-label">Average</div>
            </div>
            <div>
                <div class="sub-value">{{ stats.median_rating }} ★</div>
                <div class="sub-label">Median</div>
            </div>
        </div>
        <div class="detail">Across {{ stats.total_ratings }} ratings</div>
    </div>

    <!-- Card 2: Top Producers -->
    <div class="stat-card">
        <h3>Top Producers</h3>
        {% if stats.top_producers %}
        <ul class="top-list">
            {% for producer in stats.top_producers %}
            <li>
                <a href="#" class="filter-link" data-filter-type="producer_filter"
                    data-filter-value="{{ producer.name }}">
                    <span class="name">{{ producer.name }}</span>
                </a>
                <span class="avg">{{ producer.avg_rating }} ★ avg</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="detail">Not enough data. Rate at least 3 tracks from the same producer.</p>
        {% endif %}
    </div>

    <!-- Card 3: Top Voicebanks -->
    <div class="stat-card">
        <h3>Top Voicebanks</h3>
        {% if stats.top_voicebanks %}
        <ul class="top-list">
            {% for voicebank in stats.top_voicebanks %}
            <li>
                <a href="#" class="filter-link" data-filter-type="voicebank_filter"
                    data-filter-value="{{ voicebank.name }}">
                    <span class="name">{{ voicebank.name }}</span>
                </a>
                <span class="avg">{{ voicebank.avg_rating }} ★ avg</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="detail">Not enough data. Rate at least 3 tracks from the same voicebank.</p>
        {% endif %}
    </div>

    <!-- Card 4: Chart -->
    {% if stats.total_ratings > 0 %}
    <div class="stat-card chart-container">
        <h3>Rating Distribution</h3>
        <canvas id="ratingDistributionChart" data-ratings='{{ stats.rating_distribution|tojson|safe }}'></canvas>
    </div>
    {% endif %}
</div>


<div class="filter-container">
    <div id="rating-filter-indicator-container"></div>
    <form id="filter-form">
        <label for="title_filter">Title:</label>
        <div class="input-wrapper">
            <input type="search" name="title_filter" id="title_filter" placeholder="Search title..." autocomplete="off">
            <button type="button" class="clear-input-btn" aria-label="Clear title search">&times;</button>
        </div>
        <label for="producer_filter">Producer:</label>
        <div class="input-wrapper">
            <input type="text" name="producer_filter" id="producer_filter" list="producers-list" autocomplete="off">
            <button type="button" class="clear-input-btn" aria-label="Clear producer filter">&times;</button>
        </div>
        <datalist id="producers-list">
            {% for producer in all_producers %}<option value="{{ producer }}">{% endfor %}
        </datalist>

        <label for="voicebank_filter">Voicebank:</label>
        <div class="input-wrapper">
            <input type="text" name="voicebank_filter" id="voicebank_filter" list="voicebanks-list" autocomplete="off">
            <button type="button" class="clear-input-btn" aria-label="Clear voicebank filter">&times;</button>
        </div>
        <datalist id="voicebanks-list">
            {% for voicebank in all_voicebanks %}<option value="{{ voicebank }}">{% endfor %}
        </datalist>

        <a href="/rated_tracks" class="clear button">Clear Filters</a>
    </form>
</div>
<div class="table-wrapper">
    <table>
        <thead id="tracks-table-head">
            <tr>
                <th>Image</th>
                <th><a href="{{ request.url.path }}?sort_by=rank" data-sort="rank">Rank</a></th>
                <th class="truncate-cell"><a href="{{ request.url.path }}?sort_by=title" data-sort="title">Title</a>
                </th>
                <th class="truncate-cell"><a href="{{ request.url.path }}?sort_by=producer"
                        data-sort="producer">Producer</a></th>
                <th class="truncate-cell"><a href="{{ request.url.path }}?sort_by=voicebank"
                        data-sort="voicebank">Voicebank</a></th>
                <th><a href="{{ request.url.path }}?sort_by=published_date" data-sort="published_date">Published</a>
                </th>
                <th><a href="{{ request.url.path }}?sort_by=rating" data-sort="rating">My Rating</a></th>
            </tr>
        </thead>
        <tbody id="tracks-table-body" data-update-url="/_/rated_tracks_table_body">
            {% include "partials/tracks_table_body.html" %}
        </tbody>
    </table>
</div>
<script src="{{ url_for('static', path='js/main.js') }}"></script>
{% endblock %}
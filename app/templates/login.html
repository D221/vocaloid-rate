{% extends "base.html" %}

{% block content %}
  <div class="container mx-auto max-w-md px-4 py-8">
    <h1
      class="mb-6 text-center text-3xl font-bold text-gray-800 dark:text-white"
    >
      {{ _('Login') }}
    </h1>

    <form
      hx-post="/token"
      hx-trigger="submit"
      hx-swap="none"
      hx-on:htmx:after-request="handleAuthResponse(event)"
      class="mb-4 rounded-lg bg-white px-8 pt-6 pb-8 shadow-md dark:bg-gray-800"
    >
      {% if error_message %}
        <p class="mb-4 text-xs text-red-500 italic">{{ error_message }}</p>
      {% endif %}
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700 dark:text-gray-300"
          for="username"
        >
          {{ _('Email') }}
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border px-3 py-2 leading-tight text-gray-700 shadow focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
          id="username"
          name="username"
          type="email"
          placeholder="{{ _('Your Email') }}"
          required
        />
      </div>
      <div class="mb-6">
        <label
          class="mb-2 block text-sm font-bold text-gray-700 dark:text-gray-300"
          for="password"
        >
          {{ _('Password') }}
        </label>
        <input
          class="focus:shadow-outline mb-3 w-full appearance-none rounded border px-3 py-2 leading-tight text-gray-700 shadow focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
          id="password"
          name="password"
          type="password"
          placeholder="{{ _('Your Password') }}"
          required
        />
      </div>
      <div class="flex items-center justify-between">
        <button
          class="focus:shadow-outline rounded bg-blue-500 px-4 py-2 font-bold text-white hover:bg-blue-700 focus:outline-none dark:bg-blue-600 dark:hover:bg-blue-800"
          type="submit"
        >
          {{ _('Login') }}
        </button>
        <a
          class="inline-block align-baseline text-sm font-bold text-blue-500 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-600"
          href="/register"
        >
          {{ _("Don't have an account?") }} {{ _('Register') }}
        </a>
      </div>
    </form>
  </div>

  <script>
    function handleAuthResponse(event) {
      console.log("HTMX Auth Response Event:", event.detail);
      if (event.detail.successful) {
        console.log("Authentication successful");
        // Authentication successful, redirect to home or dashboard
        window.location.href = "/";
      } else {
        // Authentication failed, display error message
        const response = event.detail.xhr.response;
        console.error("Authentication failed. Server response:", response);
        let errorMessage = "{{ _('An unknown error occurred.') }}";
        try {
          const errorData = JSON.parse(response);
          errorMessage = errorData.detail || errorMessage;
        } catch (e) {
          console.error("Failed to parse error response:", e);
        }
        const form = event.detail.elt;
        let errorParagraph = form.querySelector(".text-red-500");
        if (!errorParagraph) {
          errorParagraph = document.createElement("p");
          errorParagraph.className = "text-red-500 text-xs italic mb-4";
          form.prepend(errorParagraph);
        }
        errorParagraph.textContent = errorMessage;
      }
    }
  </script>
{% endblock %}

{% from "macros/icons.html" import render as icon %}

<template id="playlist-data"> {{ tracks_json | safe }} </template>
{% for track in tracks %}
  <tr
    data-track-id="{{ track.id }}"
    data-track-link="{{ track.link }}"
    data-track-image-url="{{ track.image_url }}"
    data-track-title="{{ track.title }}"
    data-track-title-jp="{{ track.title_jp or '' }}"
    data-track-producer="{{ track.producer }}"
    data-track-producer-jp="{{ track.producer_jp or '' }}"
    class="mb-6 block overflow-hidden rounded-md border border-border bg-card-bg text-center shadow-md md:mb-0 md:table-row md:border-none md:bg-background md:text-left md:shadow-none"
  >
    <!-- Image -->
    <td
      data-label="{{ _('Image') }}"
      class="slim-hideable-image border-b border-border p-0 md:table-cell md:border md:p-2 md:whitespace-nowrap"
    >
      <a href="{{ track.link }}" target="_blank">
        <img
          src="{{ track.image_url }}"
          alt="{{ track.title }}"
          class="track-thumbnail block h-auto w-full rounded-t-md md:h-auto md:rounded-md"
        />
      </a>
    </td>

    <!-- Rank -->
    <td
      data-label="{{ _('Rank') }}"
      class="block border-b border-border p-3 text-center last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
    >
      {{ track.rank if track.rank is not none else '—' }}
    </td>

    <!-- Title -->
    <td
      data-label="{{ _('Title') }}"
      class="block border-b border-border p-3 text-center last:border-b-0 md:table-cell md:w-1/3 md:border md:px-3 md:py-2 md:text-left"
    >
      <!-- ACTIONS + TITLE GROUP -->
      <div
        class="slim-actions-container flex flex-col items-center md:flex-row md:items-start md:justify-between"
      >
        <div class="min-w-0 text-center md:text-left">
          <a
            href="{{ track.link }}"
            target="_blank"
            class="font-semibold hover:text-sky-text hover:underline"
            title="{% if locale == 'ja' and track.title_jp %}
              {{ track.title_jp }}
              ({{ track.title }})
            {% else %}
              {{ track.title }}{% if track.title_jp %}({{ track.title_jp }}){% endif %}
            {% endif %}"
          >
            {% if locale == 'ja' and track.title_jp %}
              {{ track.title_jp | truncate(35, True, '...') }}
              <br /><span class="slim-hideable-secondary text-sm text-gray-text"
                >({{ track.title | truncate(30, True, '...') }})</span
              >
            {% else %}
              {{ track.title | truncate(35, True, '...') }}
              {% if track.title_jp %}
                <br /><span
                  class="slim-hideable-secondary text-sm text-gray-text"
                  >({{ track.title_jp | truncate(30, True, '...') }})</span
                >
              {% endif %}
            {% endif %}
          </a>
        </div>

        <div class="mt-2 flex justify-center gap-2 md:justify-start">
          <button
            data-play-button
            class="cursor-pointer rounded border border-gray-text px-2 py-1 text-gray-text ease-in-out hover:bg-gray-hover hover:transition-colors hover:duration-200"
            data-track-id="{{ track.id }}"
            title="{{ _('Play this track') }}"
          >
            {{ icon('play', size="h-4 w-4") }}
          </button>
          <button
            data-embed-button
            title="{{ _('Toggle video player') }}"
            class="cursor-pointer rounded border border-cyan-text px-2 py-1 text-cyan-text ease-in-out hover:bg-cyan-hover hover:transition-colors hover:duration-200"
            data-youtube-url="{{ track.link }}"
          >
            {{ icon('tv', size="h-4 w-4") }}
          </button>
          <button
            data-vocadb-track-button
            class="cursor-pointer rounded border border-purple-text px-2 py-1 font-semibold text-purple-text ease-in-out hover:bg-purple-hover hover:transition-colors hover:duration-200"
            data-title-en="{{ track.title }}"
            data-producer="{{ track.producer.split(',')[0].strip() }}"
            {% if track.title_jp %}
              data-title-jp="{{ track.title_jp }}"
            {% endif %}
          >
            VocaDB
          </button>
          <button
            data-lyrics-button
            class="cursor-pointer rounded border border-green-text px-2 py-1 font-semibold text-green-text ease-in-out hover:bg-green-hover hover:transition-colors hover:duration-200"
            data-title-en="{{ track.title }}"
            data-producer="{{ track.producer.split(',')[0].strip() }}"
            {% if track.title_jp %}
              data-title-jp="{{ track.title_jp }}"
            {% endif %}
          >
            {{ _('Lyrics') }}
          </button>
          <button
            data-add-to-playlist-button
            data-track-id="{{ track.id }}"
            class="{% if track.is_in_playlist %}
              border-cyan-text text-cyan-text hover:bg-cyan-hover
            {% else %}
              border-gray-text text-gray-text hover:bg-gray-hover
            {% endif %} cursor-pointer rounded border px-2 py-1 shadow-md ease-in-out hover:transition-colors hover:duration-200"
            title="{{ _('Manage playlists') }}"
          >
            {{ icon('plus', size="h-4 w-4") }}
          </button>
        </div>
      </div>

      <div data-notes-container class="mt-2 hidden">
        <textarea
          data-notes-input
          name="notes"
          rows="4"
          class="w-full rounded border border-border p-2"
        >
{{ track.ratings[0].notes if track.ratings and track.ratings[0].notes }}</textarea
        >
      </div>

      <div data-embed-container class="hidden justify-center"></div>
      <div
        data-lyrics-container
        class="hidden max-h-96 overflow-y-auto px-5 py-3 leading-[1.6]"
      >
        <div data-lyrics-controls class="mb-4 flex items-center gap-2">
          <select
            data-lyrics-select
            class="rounded border border-border bg-background p-2 text-foreground"
            data-track-id="{{ track.id }}"
          ></select>
        </div>
        <div
          data-lyrics-metadata
          class="mb-4 border-b border-border pb-3 text-[0.8em]"
        ></div>
        <div
          data-lyrics-content
          class="leading-[1.6] whitespace-pre-wrap"
        ></div>
      </div>
    </td>

    <!-- Producer -->
    <td
      data-label="{{ _('Producer') }}"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:border md:px-3 md:py-2 md:text-left"
    >
      <!-- Use a single flex container to control the layout -->
      <div class="flex flex-col">
        <!-- Part 1: All text content -->
        <div>
          {% if locale == 'ja' and track.producer_jp %}
            {% for producer in track.producer_jp.split(',') %}
              <a
                href="#"
                class="filter-link font-semibold hover:text-sky-text hover:underline"
                data-filter-type="producer_filter"
                data-filter-value="{{ producer.strip() }}"
                title="{{ producer.strip() }}"
              >
                {{ producer.strip() | truncate(35, True, '...') }}</a
              >{% if not loop.last %},{% endif %}
            {% endfor %}
            <br /><span class="slim-hideable-secondary text-sm text-gray-text"
              >({{ track.producer | truncate(30, True, '...') }})</span
            >
          {% else %}
            {% for producer in track.producer.split(',') %}
              <a
                href="#"
                class="filter-link font-semibold hover:text-sky-text hover:underline"
                data-filter-type="producer_filter"
                data-filter-value="{{ producer.strip() }}"
                title="{{ producer.strip() }}"
              >
                {{ producer.strip() | truncate(35, True, '...') }}</a
              >{% if not loop.last %},{% endif %}
            {% endfor %}
            {% if track.producer_jp %}
              <br /><span class="slim-hideable-secondary text-sm text-gray-text"
                >({{ track.producer_jp | truncate(30, True, '...') }})</span
              >
            {% endif %}
          {% endif %}
        </div>

        <!-- Part 2: The button, with controlled margin -->
        <div
          class="slim-hideable-secondary mt-2 flex justify-center gap-2 md:justify-start"
        >
          <button
            data-vocadb-artist-button
            class="cursor-pointer rounded border border-purple-text px-2 py-1 font-semibold text-purple-text ease-in-out hover:bg-purple-hover hover:transition-colors hover:duration-200"
            data-producer="{{ track.producer.split(',')[0].strip() }}"
            title="{{ _('Search producer on VocaDB') }}"
          >
            VocaDB
          </button>
        </div>
      </div>
    </td>

    <!-- Voicebank -->
    <td
      data-label="{{ _('Voicebank') }}"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:border md:px-3 md:py-2 md:text-left"
    >
      {% if locale == 'ja' and track.voicebank_jp %}
        {% for voicebank in track.voicebank_jp.split(',') %}
          {% if voicebank.strip() %}
            <a
              href="#"
              class="filter-link font-semibold hover:text-sky-text hover:underline"
              data-filter-type="voicebank_filter"
              data-filter-value="{{ voicebank.strip() }}"
              title="{{ voicebank.strip() }}"
            >
              {{ voicebank.strip() }}</a
            >{% if not loop.last and voicebank.strip() %},{% endif %}
          {% endif %}
        {% endfor %}
        <br /><span class="slim-hideable-secondary text-sm text-gray-text"
          >({{ track.voicebank }})</span
        >
      {% else %}
        {% for voicebank in track.voicebank.split(',') %}
          {% if voicebank.strip() %}
            <a
              href="#"
              class="filter-link font-semibold hover:text-sky-text hover:underline"
              data-filter-type="voicebank_filter"
              data-filter-value="{{ voicebank.strip() }}"
              title="{{ voicebank.strip() }}"
            >
              {{ voicebank.strip() }}</a
            >{% if not loop.last and voicebank.strip() %},{% endif %}
          {% endif %}
        {% endfor %}
        {% if track.voicebank_jp %}
          <br /><span class="slim-hideable-secondary text-sm text-gray-text"
            >({{ track.voicebank_jp }})</span
          >
        {% endif %}
      {% endif %}
    </td>

    <!-- Published -->
    <td
      data-label="{{ _('Published') }}"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
      title="{{ track.published_date.strftime('%Y-%m-%d') }}"
    >
      {{ track.published_date | time_ago }}
      <span class="inline-block w-24 font-bold text-header md:hidden"
        >{{ _('Published') }}</span
      >
    </td>

    <!-- My Rating -->
    <td
      data-label="{{ _('My Rating') }}"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
    >
      {% set current_rating = track.ratings[0].rating if track.ratings else 0 %}
      <form
        data-rating-form
        action="/rate/{{ track.id }}"
        method="post"
        class="flex items-center justify-center gap-2.5 md:justify-between"
      >
        <div
          data-star-rating
          class="relative inline-block cursor-pointer text-2xl"
          data-rating="{{ current_rating }}"
          style="--rating-width: {{ (current_rating / 10.0) * 100 }}%;"
        >
          <div class="text-gray-400 select-none">★★★★★★★★★★</div>
          <div
            class="pointer-events-none absolute top-0 left-0 overflow-hidden text-yellow-400 select-none"
            style="width: var(--rating-width, 0%);"
          >
            ★★★★★★★★★★
          </div>
          {% for i in range(1, 11) %}
            <input
              class="hidden"
              type="radio"
              name="rating"
              value="{{ i }}"
              id="star-{{ track.id }}-{{ i }}"
              {% if current_rating==i %}
                checked
              {% endif %}
            />
          {% endfor %}
        </div>

        <div class="flex items-center gap-2">
          {% set has_note = track.ratings and track.ratings[0].notes %}
          <button
            type="button"
            data-notes-toggle
            class="{% if has_note %}
              border-cyan-text text-cyan-text hover:bg-green-hover
            {% else %}
              text-gray-text hover:bg-gray-hover
            {% endif %} cursor-pointer rounded border px-2 py-1 font-bold shadow-md ease-in-out hover:transition-colors hover:duration-200"
          >
            {{ _('Edit Note') if has_note else _('Add Note') }}
          </button>
          {% if track.ratings %}
            <button
              data-clear-rating
              title="{{ _('Clear my rating for this track') }}"
              type="button"
              data-delete-endpoint="/rate/{{ track.id }}/delete"
              class="cursor-pointer rounded border border-red-text p-1 font-bold text-red-text shadow-md ease-in-out hover:bg-red-hover hover:transition-colors hover:duration-200"
            >
              {{ icon('xmark', size="h-6 w-6") }}
            </button>
          {% endif %}
        </div>
      </form>
    </td>
  </tr>
{% endfor %}

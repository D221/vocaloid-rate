{% for track in tracks %}
<tr>
    <td>
        <a href="{{ track.link }}" target="_blank">
            <img src="{{ track.image_url }}" alt="{{ track.title }}" width="120" class="track-thumbnail">
        </a>
    </td>
    <td>{{ track.rank if track.rank is not none else 'â€”' }}</td>
    <td data-label="Title" class="truncate-cell">
        <a href="{{ track.link }}" target="_blank">{{ track.title }}</a>
        {% if track.title_jp %}<br>({{ track.title_jp }}){% endif %}

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="embed-button" data-youtube-url="{{ track.link }}">Embed</button>
            <button class="vocadb-button" data-title-en="{{ track.title }}"
                data-producer="{{ track.producer.split(',')[0].strip() }}" {% if track.title_jp
                %}data-title-jp="{{ track.title_jp }}" {% endif %}>VocaDB</button>
            <button class="lyrics-button" data-title-en="{{ track.title }}"
                data-producer="{{ track.producer.split(',')[0].strip() }}" {% if track.title_jp
                %}data-title-jp="{{ track.title_jp }}" {% endif %}>Lyrics</button>
        </div>


        <!-- Media Containers -->
        <div class="youtube-embed-container" style="display: none;"></div>
        <div class="lyrics-container" style="display: none;">
            <div class="lyrics-controls">
                <select class="lyrics-select" data-track-id="{{ track.id }}"></select>
            </div>
            <div class="lyrics-metadata"></div>
            <div class="lyrics-content"></div>
        </div>
    </td>
    <td class="truncate-cell">
        {% for producer in track.producer.split(',') %}
        <a href="#" class="filter-link" data-filter-type="producer_filter" data-filter-value="{{ producer.strip() }}">{{
            producer.strip() }}</a>{% if not loop.last %},{% endif %}
        {% endfor %}
    </td>
    <td class="truncate-cell">
        {% for voicebank in track.voicebank.split(',') %}
        <a href="#" class="filter-link" data-filter-type="voicebank_filter"
            data-filter-value="{{ voicebank.strip() }}">{{ voicebank.strip() }}</a>{% if not loop.last %},{% endif %}
        {% endfor %}
    </td>
    <td class="published-date" data-date="{{ track.published_date.isoformat() }}"
        title="{{ track.published_date.strftime('%Y-%m-%d') }}">
    </td>
    <td class="rating-cell">
        {% set current_rating = track.ratings[0].rating if track.ratings else 0 %}
        <form action="/rate/{{ track.id }}" method="post" class="rating-form">
            <div class="star-rating-container" data-rating="{{ current_rating }}"
                style="--rating-width: {{ (current_rating / 10.0) * 100 }}%;">
                {% for i in range(1, 11) %}
                <input type="radio" name="rating" value="{{ i }}" id="star-{{ track.id }}-{{ i }}" {% if
                    current_rating==i %}checked{% endif %}>
                {% endfor %}
            </div>
            <div class="notes-container">
                {% set has_note = track.ratings and track.ratings[0].notes %}
                <button type="button" class="notes-toggle-btn {% if has_note %}has-note{% endif %}">
                    {{ 'Edit Note' if has_note else 'Add Note' }}
                </button>
                <textarea name="notes" class="notes-input"
                    style="display: none;">{{ track.ratings[0].notes if has_note }}</textarea>
            </div>

        </form>
        {% if track.ratings %}
        <form action="/rate/{{ track.id }}/delete" method="post" class="delete-rating-form">
            <button type="submit" class="clear-rating-btn">X</button>
        </form>
        {% endif %}
    </td>
</tr>
{% endfor %}
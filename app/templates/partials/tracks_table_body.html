{% from "macros/icons.html" import render as icon %}

<template id="playlist-data"> {{ tracks_json | safe }} </template>
{% for track in tracks %}
  <tr
    data-track-id="{{ track.id }}"
    class="mb-6 block overflow-hidden rounded-md border border-border bg-card-bg text-center shadow-md md:mb-0 md:table-row md:border-none md:bg-background md:text-left md:shadow-none"
  >
    <!-- Image -->
    <td
      data-label="Image"
      class="border-b border-border p-0 md:table-cell md:border md:p-2 md:whitespace-nowrap"
    >
      <a href="{{ track.link }}" target="_blank">
        <img
          src="{{ track.image_url }}"
          alt="{{ track.title }}"
          class="track-thumbnail block h-auto w-full rounded-t-md md:h-auto md:rounded-md"
        />
      </a>
    </td>

    <!-- Rank -->
    <td
      data-label="Rank"
      class="block border-b border-border p-3 text-center last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
    >
      {{ track.rank if track.rank is not none else '—' }}
    </td>

    <!-- Title -->
    <td
      data-label="Title"
      class="block border-b border-border p-3 text-center last:border-b-0 md:table-cell md:w-1/3 md:border md:px-3 md:py-2 md:text-left"
    >
      <a
        href="{{ track.link }}"
        target="_blank"
        class="font-semibold hover:text-sky-text hover:underline"
        title="{{ track.title }}"
      >
        {{ track.title | truncate(35, True, '...') }}
      </a>
      {% if track.title_jp %}<br />({{ track.title_jp }}){% endif %}

      <div class="mt-2 flex justify-center gap-2 md:justify-start">
        <button
          data-play-button
          class="cursor-pointer rounded border border-gray-text px-2 py-1 text-gray-text transition-colors duration-200 ease-in-out hover:bg-gray-hover"
          data-track-id="{{ track.id }}"
          title="Play this track"
        >
          {{ icon('play', size="h-4 w-4") }}
        </button>
        <button
          data-embed-button
          class="cursor-pointer rounded border border-cyan-text px-2 py-1 text-cyan-text transition-colors duration-200 ease-in-out hover:bg-cyan-hover"
          data-youtube-url="{{ track.link }}"
        >
          {{ icon('tv', size="h-4 w-4") }}
        </button>
        <button
          data-vocadb-track-button
          class="cursor-pointer rounded border border-purple-text px-2 py-1 font-semibold text-purple-text transition-colors duration-200 ease-in-out hover:bg-purple-hover"
          data-title-en="{{ track.title }}"
          data-producer="{{ track.producer.split(',')[0].strip() }}"
          {%
            if
            track.title_jp
          %}
            data-title-jp="{{ track.title_jp }}"
          {% endif %}
        >
          VocaDB
        </button>
        <button
          data-lyrics-button
          class="cursor-pointer rounded border border-green-text px-2 py-1 font-semibold text-green-text transition-colors duration-200 ease-in-out hover:bg-green-hover"
          data-title-en="{{ track.title }}"
          data-producer="{{ track.producer.split(',')[0].strip() }}"
          {%
            if
            track.title_jp
          %}
            data-title-jp="{{ track.title_jp }}"
          {% endif %}
        >
          Lyrics
        </button>
        <button
          data-add-to-playlist-button
          data-track-id="{{ track.id }}"
          class="{% if track.is_in_playlist %}
            border-green-text text-green-text hover:bg-green-hover
          {% else %}
            border-amber-text text-amber-text hover:bg-amber-hover
          {% endif %} cursor-pointer rounded border px-2 py-1 shadow-md transition-colors duration-200 ease-in-out"
          title="Manage playlists"
        >
          {{ icon('plus', size="h-4 w-4") }}
        </button>
      </div>

      <div data-notes-container class="mt-2 hidden">
        <textarea
          data-notes-input
          name="notes"
          rows="4"
          class="w-full rounded border border-border p-2"
        >
{{ track.ratings[0].notes if track.ratings and track.ratings[0].notes }}</textarea
        >
      </div>

      <div data-embed-container class="hidden justify-center"></div>
      <div
        data-lyrics-container
        class="hidden max-h-96 overflow-y-auto px-5 py-3 leading-[1.6]"
      >
        <div data-lyrics-controls class="mb-4 flex items-center gap-2">
          <select
            data-lyrics-select
            class="rounded border border-border p-2"
            data-track-id="{{ track.id }}"
          ></select>
        </div>
        <div
          data-lyrics-metadata
          class="mb-4 border-b border-border pb-3 text-[0.8em]"
        ></div>
        <div
          data-lyrics-content
          class="leading-[1.6] whitespace-pre-wrap"
        ></div>
      </div>
    </td>

    <!-- Producer -->
    <td
      data-label="Producer"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:border md:px-3 md:py-2 md:text-left"
    >
      <div>
        {% for producer in track.producer.split(',') %}
          <a
            href="#"
            class="filter-link font-semibold hover:text-sky-text hover:underline"
            data-filter-type="producer_filter"
            data-filter-value="{{ producer.strip() }}"
            title="{{ producer.strip() }}"
          >
            {{ producer.strip() | truncate(35, True, '...') }} </a
          >{% if not loop.last %},{% endif %}
        {% endfor %}
      </div>
      <div class="mt-2 flex justify-center gap-2 md:justify-start">
        <button
          data-vocadb-artist-button
          class="cursor-pointer rounded border border-purple-text px-2 py-1 font-semibold text-purple-text transition-colors duration-200 ease-in-out hover:bg-purple-hover"
          data-producer="{{ track.producer.split(',')[0].strip() }}"
          title="Search producer on VocaDB"
        >
          VocaDB
        </button>
      </div>
    </td>

    <!-- Voicebank -->
    <td
      data-label="Voicebank"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:border md:px-3 md:py-2 md:text-left"
    >
      {% for voicebank in track.voicebank.split(',') %}
        <a
          href="#"
          class="filter-link font-semibold hover:text-sky-text hover:underline"
          data-filter-type="voicebank_filter"
          data-filter-value="{{ voicebank.strip() }}"
          title="{{ voicebank.strip() }}"
        >
          {{ voicebank.strip() | truncate(35, True, '...') }} </a
        >{% if not loop.last %},{% endif %}
      {% endfor %}
    </td>

    <!-- Published -->
    <td
      data-label="Published"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
      title="{{ track.published_date.strftime('%Y-%m-%d') }}"
    >
      {{ track.published_date | time_ago }}
      <span class="inline-block w-24 font-bold text-header md:hidden"
        >Published</span
      >
    </td>

    <!-- My Rating -->
    <td
      data-label="My Rating"
      class="block border-b border-border p-3 text-left last:border-b-0 md:table-cell md:w-1 md:min-w-0 md:border md:px-3 md:py-2 md:text-left md:whitespace-nowrap"
    >
      {% set current_rating = track.ratings[0].rating if track.ratings else 0 %}
      <form
        data-rating-form
        action="/rate/{{ track.id }}"
        method="post"
        class="flex items-center justify-center gap-2.5 md:justify-between"
      >
        <div
          data-star-rating
          class="relative inline-block cursor-pointer text-2xl"
          data-rating="{{ current_rating }}"
          style="--rating-width: {{ (current_rating / 10.0) * 100 }}%;"
        >
          <div class="text-gray-400 select-none">★★★★★★★★★★</div>
          <div
            class="pointer-events-none absolute top-0 left-0 overflow-hidden text-yellow-400 select-none"
            style="width: var(--rating-width, 0%);"
          >
            ★★★★★★★★★★
          </div>
          {% for i in range(1, 11) %}
            <input
              class="hidden"
              type="radio"
              name="rating"
              value="{{ i }}"
              id="star-{{ track.id }}-{{ i }}"
              {%
                if
                current_rating==i
              %}
                checked
              {% endif %}
            />
          {% endfor %}
        </div>

        <div class="flex items-center gap-2">
          {% set has_note = track.ratings and track.ratings[0].notes %}
          <button
            type="button"
            data-notes-toggle
            class="{% if has_note %}
              border-green-text text-green-text hover:bg-green-hover
            {% else %}
              text-gray-text hover:bg-gray-hover
            {% endif %} cursor-pointer rounded border px-2 py-1 font-bold shadow-md transition-colors duration-200 ease-in-out"
          >
            {{ 'Edit Note' if has_note else 'Add Note' }}
          </button>
          {% if track.ratings %}
            <button
              data-clear-rating
              type="button"
              data-delete-endpoint="/rate/{{ track.id }}/delete"
              class="cursor-pointer rounded border border-red-text p-1 font-bold text-red-text shadow-md transition-colors duration-200 ease-in-out hover:bg-red-hover"
            >
              {{ icon('xmark', size="h-6 w-6") }}
            </button>
          {% endif %}
        </div>
      </form>
    </td>
  </tr>
{% endfor %}

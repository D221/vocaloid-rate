{% from "macros/icons.html" import render as icon %}

<div
  class="mb-8 flex flex-wrap items-center justify-between gap-4 border-b border-border pb-4"
>
  <!-- Mobile Menu (Order 1 on mobile, hidden on desktop) -->
  <div class="relative order-1 md:hidden">
    <!-- Hamburger Button -->
    <button
      id="menu-toggle"
      class="rounded border border-border p-2"
      aria-label="{{ _('Toggle menu') }}"
    >
      {{ icon("bars", size="h-6 w-6") }}
    </button>

    <!-- Dropdown Menu -->
    <div
      id="nav-links"
      class="absolute left-0 z-10 mt-2 hidden w-48 origin-top-left rounded-md border border-border bg-card-bg p-2 shadow-lg"
    >
      <!-- MODIFIED LINE IS HERE -->
      <div class="flex flex-col divide-y divide-border">
        {% if request.url.path != '/' %}
          <a href="/" class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Main Chart') }}</a
          >
        {% endif %}
        {% if request.url.path != '/recently_added' %}
          <a
            href="/recently_added"
            class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Recently Added') }}</a
          >
        {% endif %}
        {% if request.url.path != '/playlists' %}
          <a
            href="/playlists"
            class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Playlists') }}</a
          >
        {% endif %}
        {% if request.url.path.startswith('/playlist/') %}
          {% set playlist_id = request.url.path.split('/')[-1] %}
          {% if request.url.path.startswith('/playlist/edit/') %}
            <a
              href="/playlist/{{ playlist_id }}"
              class="block rounded px-4 py-2 text-amber-text hover:bg-amber-hover"
              >{{ _('View Playlist') }}</a
            >
          {% else %}
            <a
              href="/playlist/edit/{{ playlist_id }}"
              class="block rounded px-4 py-2 text-amber-text hover:bg-amber-hover"
              >{{ _('Edit Details') }}</a
            >
          {% endif %}
        {% endif %}
        {% if request.url.path != '/rated_tracks' %}
          <a
            href="/rated_tracks"
            class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Rated Tracks') }}</a
          >
        {% endif %}
        {% if request.url.path != '/recommendations' %}
          <a
            href="/recommendations"
            class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Recommendations') }}</a
          >
        {% endif %}
        {% if request.url.path != '/options' %}
          <a href="/options" class="block rounded px-4 py-2 hover:bg-gray-hover"
            >{{ _('Options') }}</a
          >
        {% endif %}
      </div>
    </div>
  </div>

  <!-- The Title Block (Order 2 on mobile, Order 1 on desktop) -->
  <div
    class="order-2 grow text-center md:order-1 md:text-left"
    data-playlist-id="{{ playlist.id if playlist else '' }}"
  >
    <!-- View Mode for Title -->
    <h1 class="group text-4xl font-bold text-header">
      <span class="view-mode">{{ title }}</span>
      <input
        type="text"
        value="{{ title }}"
        class="edit-mode hidden w-full rounded border border-border bg-background p-1 text-4xl font-bold text-foreground"
      />

      {# Show edit icon only on the edit page #}
      {% if request.url.path.startswith('/playlist/edit/') %}
        <button
          data-edit-field="name"
          aria-label="{{ _('Edit playlist name') }}"
          class="ml-2 text-gray-text opacity-0 transition-opacity group-hover:opacity-100"
        >
          {{ icon('pencil', size="h-4 w-4") }}
        </button>
      {% endif %}
    </h1>

    <!-- View Mode for Subtitle/Description -->
    {% if subtitle %}
      <p class="group text-gray-text">
        <span class="view-mode">{{ subtitle }}</span>
        <textarea
          rows="2"
          class="edit-mode hidden w-full rounded border border-border bg-background p-1 text-foreground"
        >
{{ subtitle.replace('No description.', '') }}</textarea
        >

        {# Show edit icon only on the edit page #}
        {% if request.url.path.startswith('/playlist/edit/') %}
          <button
            data-edit-field="description"
            aria-label="{{ _('Edit playlist description') }}"
            class="ml-2 text-gray-text opacity-0 transition-opacity group-hover:opacity-100"
          >
            {{ icon('pencil', size="h-4 w-4") }}
          </button>
        {% endif %}
      </p>
    {% endif %}

    {% if request.url.path == '/' %}
      <span
        id="last-updated"
        class="{% if is_db_outdated %}
          text-red-text
        {% else %}
          text-gray-text
        {% endif %} text-sm"
      >
        {% if last_update %}
          {{ _('Last updated:') }}
          {{ last_update.updated_at.strftime('%Y-%m-%d %H:%M') }}
          {% if is_db_outdated and update_age_days is not none %}
            <br />{{ _('Your database is %(days)s day(s) old, please update.')|format(days=update_age_days) }}
          {% endif %}
        {% else %}
          {{ _('Database not updated yet. Please update.') }}
        {% endif %}
      </span>
    {% endif %}
  </div>

  <!-- Desktop Nav & Theme Switcher (Order 3 on mobile, Order 2 on desktop) -->
  <div class="order-3 flex shrink-0 items-center gap-4 md:order-2">
    <!-- Desktop Navigation (hidden on mobile) -->
    <div class="hidden items-center gap-4 md:flex">
      {% set is_active = request.url.path == '/' %}
      <a
        href="/"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Main Chart') }}
      </a>

      {% set is_active = request.url.path == '/recently_added' %}
      <a
        href="/recently_added"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Recently Added') }}
      </a>

      {# Show "Playlists" if we are NOT on the playlists page #}
      {% set is_active = request.url.path == '/playlists' %}
      <a
        href="/playlists"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Playlists') }}
      </a>

      {% if request.url.path.startswith('/playlist/') %}

        {# Extract the playlist ID. This works for both /view/ and /edit/ URLs #}
        {% set playlist_id = request.url.path.split('/')[-1] %}

        {# CASE 1: We are on the EDIT page, so show a "View" button #}
        {% if request.url.path.startswith('/playlist/edit/') %}
          <a
            href="/playlist/{{ playlist_id }}"
            class="cursor-pointer rounded border border-amber-text p-3 font-bold text-amber-text shadow-md ease-in-out hover:bg-cyan-hover hover:transition-colors hover:duration-200"
          >
            {{ _('View Playlist') }}
          </a>

          {# CASE 2: We are on the VIEW page, so show an "Edit" button #}
        {% else %}
          <a
            href="/playlist/edit/{{ playlist_id }}"
            id="toggle-edit-playlist"
            class="cursor-pointer rounded border border-amber-text p-3 font-bold text-amber-text shadow-md ease-in-out hover:bg-amber-hover hover:transition-colors hover:duration-200"
          >
            {{ _('Edit Details') }}
          </a>
        {% endif %}
      {% endif %}

      {# Show "View Rated" if we are NOT on the rated tracks page #}
      {% set is_active = request.url.path =='/rated_tracks' %}
      <a
        href="/rated_tracks"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Rated Tracks') }}
      </a>

      {% set is_active = request.url.path == '/recommendations' %}
      <a
        href="/recommendations"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Recommendations') }}
      </a>

      {# Show "Options" if we are NOT on the rated tracks page #}
      {% set is_active = request.url.path == '/options' %}
      <a
        href="/options"
        class="{% if is_active %}
          border-gray-text text-gray-text hover:bg-gray-hover cursor-default
          pointer-events-none
        {% else %}
          border-cyan-text text-cyan-text
        {% endif %} rounded border p-3 font-bold shadow-md transition-colors duration-200 ease-in-out"
      >
        {{ _('Options') }}
      </a>

      <!-- Language Switcher -->
      <a
        href="{% if locale == 'ja' %}?lang=en{% else %}?lang=ja{% endif %}"
        class="cursor-pointer rounded border border-gray-text p-3 font-bold text-gray-text shadow-md ease-in-out hover:bg-gray-hover hover:transition-colors hover:duration-200"
        title="Switch Language"
      >
        {{ icon("globe", size="h-5 w-5") }}
        <span>{% if locale == 'ja' %}English{% else %}日本語{% endif %}</span>
      </a>
    </div>
  </div>
</div>
